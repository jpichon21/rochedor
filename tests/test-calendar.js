const Nightmare = require('nightmare')
const addContext = require('mochawesome/addContext')
const sinon = require('sinon')
const request = require('request')
const chai = require('chai')
const should = chai.should()

const imgDir = './tests/reports/screenshots/inscription'

describe('Load Page', function () {
  this.timeout('30s')
  let nightmare = null
  beforeEach(() => {
    nightmare = new Nightmare({ show: true })
  })
  describe('L\'inscription doit se dérouler sans erreur', () => {
    it('Les actions suivantes doivent se derouler sans timout', done => {
      nightmare
        .goto('http://127.0.0.1:8001/inscription-retraite?id=3176')
        .wait('.item.connection .button.yes')
        .click('.item.connection .button.yes')
        .wait('.panel.connection')
        .type('.panel.connection .input.username', 'admin')
        .type('.panel.connection .input.password', 'admin')
        .click('.panel.connection .button.submit')
        .wait('.item.participants.active')
        .click('.modify-you.button')
        .wait('.panel.you')
        .type('.panel.you .input.password', 'admin')
        .select('.panel.you .select.transport', 'perso')
        .click('.panel.you .input.button.submit')
        .click('.item.participants.active .add-participant')
        .wait('.panel.add')
        .select('.panel.add .select.coltyp', 'conjo')
        .select('.panel.add .select.colp', '37898')
        .select('.panel.add .select.civil', 'Mme')
        .type('.panel.add .input.prenom', 'Helene')
        .type('.panel.add .input.nom', 'Doooooe')
        .type('.panel.add .textarea.adresse', '8 rue des passants')
        .type('.panel.add .input.cp', '25000')
        .type('.panel.add .input.ville', 'Besançon')
        .type('.panel.add .input.pays', 'France')
        .type('.panel.add .input.tel', '038114578')
        .type('.panel.add .input.mobil', '038114578')
        .type('.panel.add .input.email', 'zmail@zmail.com')
        .type('.panel.add .input.datnaiss', '24/09/1995')
        .type('.panel.add .input.profession', 'Garagiste')
        .select('.panel.add .select.transport', 'perso')
        .type('.panel.add .textarea.memo', 'Diabétique végétarien')
        .click('.panel.add .input.button.submit')
        .wait(600)
        .click('.validate-participants.button')
        .wait('.item.validation.active')
        .end()
        .then(function (result) { done() })
        .catch(done)
    })
    describe('Le mail doit etre reçu', () => {
      it('Il s\'agit du bonne email', (done) => {
        request('http://127.0.0.1:8083/api/emails', function (err, res, body) {
          res.statusCode.should.eql(200)
          res.headers['content-type'].should.contain('application/json')
          body = JSON.parse(body)
          body[0].subject.should.eql('Demande d\'inscription')
          body[0].headers.from.should.eql('Logomotion <technique@logomotionfr>')
          done()
        })
      })
    })
  })
})
